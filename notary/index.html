<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OCC Notary + Verifier</title>

<style>
:root{
  --bg:#07080b;
  --panel:rgba(255,255,255,.05);
  --stroke:rgba(255,255,255,.10);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.6);
  --good:#22c55e;
  --bad:#ef4444;
  --blue:#60a5fa;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(800px 500px at 20% 20%, rgba(96,165,250,.08), transparent 60%),
    radial-gradient(800px 500px at 80% 30%, rgba(34,197,94,.06), transparent 60%),
    var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
.wrap{max-width:1100px;margin:auto;padding:32px 18px 60px;}
h1{margin:0 0 6px;font-size:28px;letter-spacing:-.6px}
.sub{color:var(--muted);font-size:13px;margin-bottom:18px}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}

.card{
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
  border:1px solid var(--stroke);
  border-radius:16px;
  padding:18px;
}
.card h2{margin:0 0 8px;font-size:16px}
.field{margin-top:12px}
.label{font-size:12px;color:var(--muted);margin-bottom:4px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input[type=file]{padding:6px 8px;border-radius:10px;background:#000;border:1px solid var(--stroke);color:var(--muted)}
button{
  padding:9px 12px;
  border-radius:10px;
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.05);
  color:var(--text);
  font-weight:600;
  cursor:pointer;
}
button.primary{background:rgba(96,165,250,.18);border-color:rgba(96,165,250,.4)}
button:disabled{opacity:.5;cursor:not-allowed}
.kv{margin-top:12px;font-size:12px;font-family:ui-monospace,monospace;word-break:break-all}
.status{
  margin-top:12px;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--stroke);
  font-size:12px;
  color:var(--muted);
}
.status.ok{background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.3);color:#86efac}
.status.bad{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.3);color:#fca5a5}
small{color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">
  <h1>OCC Notary + Verifier</h1>
  <div class="sub">
    Hash a file, generate a fresh key, sign the hash, export proof.json. Then verify it — fully client-side.
  </div>

  <div class="grid">

    <!-- NOTARY -->
    <div class="card">
      <h2>Notary</h2>

      <div class="field">
        <div class="label">Artifact file</div>
        <input id="notaryFile" type="file">
      </div>

      <div class="row" style="margin-top:10px">
        <button id="notarizeBtn" class="primary" disabled>Notarize</button>
        <button id="downloadBtn" disabled>Download proof.json</button>
      </div>

      <div class="kv">
        <div><strong>Hash:</strong> <span id="notaryHash">—</span></div>
        <div><strong>Public Key (SPKI b64):</strong> <span id="notaryPub">—</span></div>
        <div><strong>Signature (b64):</strong> <span id="notarySig">—</span></div>
      </div>

      <div id="notaryStatus" class="status">
        Select a file, then click Notarize.
      </div>
    </div>

    <!-- VERIFIER -->
    <div class="card">
      <h2>Verifier</h2>

      <div class="field">
        <div class="label">1) Artifact file</div>
        <input id="verifyFile" type="file">
      </div>

      <div class="field">
        <div class="label">2) proof.json</div>
        <input id="verifyProof" type="file" accept="application/json,.json">
      </div>

      <div class="row" style="margin-top:10px">
        <button id="verifyBtn" class="primary" disabled>Verify</button>
      </div>

      <div class="kv">
        <div><strong>Recomputed Hash:</strong> <span id="verifyHash">—</span></div>
      </div>

      <div id="verifyStatus" class="status">
        Select artifact + proof.json, then click Verify.
      </div>
    </div>

  </div>

  <div style="margin-top:20px">
    <small>
      Demo only. Real OCC deployments validate signer keys against trusted roots and enforce boundary constraints.
    </small>
  </div>

</div>

<script>
const $ = id => document.getElementById(id);

let currentProof = null;
let verifyFile = null;
let verifyProof = null;
let signingAlgo = null;

// ---- Utilities ----
function bytesToHex(bytes){
  return Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join("");
}
function hexToBytes(hex){
  const arr=new Uint8Array(hex.length/2);
  for(let i=0;i<arr.length;i++){
    arr[i]=parseInt(hex.substr(i*2,2),16);
  }
  return arr;
}
function bytesToB64(bytes){
  return btoa(String.fromCharCode(...bytes));
}
function b64ToBytes(b64){
  const bin=atob(b64);
  return Uint8Array.from(bin,c=>c.charCodeAt(0));
}
async function sha256Hex(file){
  const buf=await file.arrayBuffer();
  const hash=await crypto.subtle.digest("SHA-256",buf);
  return bytesToHex(new Uint8Array(hash));
}
function setStatus(el,type,msg){
  el.classList.remove("ok","bad");
  if(type) el.classList.add(type);
  el.innerHTML=msg;
}

// ---- Pick algorithm (Ed25519 preferred) ----
(async()=>{
  try{
    await crypto.subtle.generateKey({name:"Ed25519"},true,["sign","verify"]);
    signingAlgo="Ed25519";
  }catch{
    signingAlgo="ECDSA";
  }
})();

// ---- Notary ----
$("notaryFile").addEventListener("change",e=>{
  $("notarizeBtn").disabled=!e.target.files.length;
});

$("notarizeBtn").addEventListener("click",async()=>{
  const file=$("notaryFile").files[0];
  if(!file) return;

  try{
    const hashHex=await sha256Hex(file);
    $("notaryHash").textContent=hashHex;

    let keypair;
    if(signingAlgo==="Ed25519"){
      keypair=await crypto.subtle.generateKey({name:"Ed25519"},true,["sign","verify"]);
    }else{
      keypair=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},true,["sign","verify"]);
    }

    const msg=hexToBytes(hashHex);
    const sigBuf=await crypto.subtle.sign(
      signingAlgo==="Ed25519"
        ? {name:"Ed25519"}
        : {name:"ECDSA",hash:"SHA-256"},
      keypair.privateKey,
      msg
    );
    const sigB64=bytesToB64(new Uint8Array(sigBuf));

    const pubSpki=await crypto.subtle.exportKey("spki",keypair.publicKey);
    const pubB64=bytesToB64(new Uint8Array(pubSpki));

    $("notaryPub").textContent=pubB64;
    $("notarySig").textContent=sigB64;

    currentProof={
      version:"occ-proof-v1",
      createdAt:new Date().toISOString(),
      hash:{alg:"SHA-256",hex:hashHex},
      signature:{
        alg:signingAlgo,
        publicKeySpkiB64:pubB64,
        sigB64:sigB64
      }
    };

    $("downloadBtn").disabled=false;
    setStatus($("notaryStatus"),"ok","Proof created. Download proof.json.");

  }catch(err){
    setStatus($("notaryStatus"),"bad","Error: "+err.message);
  }
});

$("downloadBtn").addEventListener("click",()=>{
  if(!currentProof) return;
  const blob=new Blob([JSON.stringify(currentProof,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="proof.json";
  a.click();
  URL.revokeObjectURL(url);
});

// ---- Verifier ----
$("verifyFile").addEventListener("change",e=>{
  verifyFile=e.target.files[0]||null;
  $("verifyBtn").disabled=!(verifyFile&&verifyProof);
});
$("verifyProof").addEventListener("change",async e=>{
  const f=e.target.files[0];
  verifyProof=null;
  if(!f) return;
  try{
    verifyProof=JSON.parse(await f.text());
  }catch{
    verifyProof=null;
  }
  $("verifyBtn").disabled=!(verifyFile&&verifyProof);
});

$("verifyBtn").addEventListener("click",async()=>{
  try{
    const recomputed=await sha256Hex(verifyFile);
    $("verifyHash").textContent=recomputed;

    if(recomputed!==verifyProof.hash.hex){
      setStatus($("verifyStatus"),"bad","Hash mismatch.");
      return;
    }

    const pubKey=await crypto.subtle.importKey(
      "spki",
      b64ToBytes(verifyProof.signature.publicKeySpkiB64),
      verifyProof.signature.alg==="Ed25519"
        ? {name:"Ed25519"}
        : {name:"ECDSA",namedCurve:"P-256"},
      true,
      ["verify"]
    );

    const ok=await crypto.subtle.verify(
      verifyProof.signature.alg==="Ed25519"
        ? {name:"Ed25519"}
        : {name:"ECDSA",hash:"SHA-256"},
      pubKey,
      b64ToBytes(verifyProof.signature.sigB64),
      hexToBytes(verifyProof.hash.hex)
    );

    if(ok){
      setStatus($("verifyStatus"),"ok","Valid: hash matches and signature verifies.");
    }else{
      setStatus($("verifyStatus"),"bad","Signature invalid.");
    }

  }catch(err){
    setStatus($("verifyStatus"),"bad","Error: "+err.message);
  }
});
</script>

</body>
</html>
